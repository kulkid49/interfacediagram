<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI-SAP Invoice Exception Handling ¬∑ Integration Architecture</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, system-ui, sans-serif;
      background: #f5f7fb;
      color: #16253f;
      padding: 1.2rem;
    }
    .document {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 18px 36px rgba(0,0,0,0.09);
      padding: 1.4rem;
    }
    h1 { margin: 0 0 0.5rem; }
    h2 { margin-top: 1.8rem; }
    .interactive-diagram-wrap { margin: 1rem 0 1.2rem; }
    .interactive-diagram {
      position: relative;
      border: 1px solid #c5d2e2;
      border-radius: 14px;
      overflow: hidden;
      background: #f8fbff;
    }
    .interactive-diagram svg { width: 100%; height: auto; display: block; }

    .component-shape {
      stroke: #415c85;
      stroke-width: 2;
      fill: #eaf2ff;
      cursor: pointer;
      transition: fill 0.2s, stroke-width 0.2s, filter 0.2s;
    }
    .component-shape:hover,
    .component-shape.active {
      fill: #d3e5ff;
      stroke-width: 3;
      filter: drop-shadow(0 0 5px rgba(37, 102, 190, 0.55));
    }

    .arrow {
      stroke: #3a5578;
      stroke-width: 3;
      fill: none;
      cursor: pointer;
      transition: stroke 0.15s, stroke-width 0.15s, filter 0.15s;
      marker-end: url(#arrowhead);
      pointer-events: stroke;
    }
    .arrow:hover,
    .arrow.active {
      stroke: #e12b39;
      stroke-width: 5;
      filter: drop-shadow(0 0 6px rgba(225, 43, 57, 0.6));
    }
    .node-label { font-size: 16px; font-weight: 600; fill: #142238; pointer-events: none; }

    .diagram-tooltip {
      position: absolute;
      display: none;
      pointer-events: none;
      background: #fff;
      border: 1px solid #000;
      border-radius: 10px;
      padding: 10px;
      max-width: 300px;
      z-index: 1000;
      box-shadow: 0 10px 22px rgba(0,0,0,0.15);
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .diagram-panel {
      margin-top: 0.8rem;
      border: 1px solid #c5d2e2;
      border-radius: 12px;
      padding: 0.8rem;
      background: #f5f9ff;
    }
    .controls { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
    button {
      border: 1px solid #29486f;
      border-radius: 999px;
      background: #fff;
      color: #29486f;
      padding: 0.25rem 0.75rem;
      cursor: pointer;
    }
    .flow-step {
      background: #fff;
      border-left: 4px solid #2e4f8a;
      border-radius: 0 12px 12px 0;
      padding: 0.7rem 0.9rem;
      margin: 0.7rem 0;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { border: 1px solid #d8e2ef; padding: 0.55rem; text-align: left; }
    th { background: #1f3658; color: #fff; }
    @media (max-width: 768px) {
      body { padding: 0.5rem; }
      .document { padding: 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="document">
    <h1>Interface Design V1.0 (Flat Europe-Germany PoC)</h1>
    <p>Interactive SVG version of the AI-SAP Invoice Exception Handling Integration Architecture.</p>

    <h2>üèûÔ∏è System Landscape</h2>
    <div class="interactive-diagram-wrap">
      <div class="interactive-diagram" id="interactiveDiagram">
        <svg id="architectureSvg" viewBox="0 0 1400 860" role="img" aria-label="AI-SAP invoice architecture">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L10,4 L0,8 Z" fill="currentColor"></path>
            </marker>
          </defs>

          <!-- Components -->
          <g id="sap-trigger" data-kind="component" tabindex="0"><rect class="component-shape" x="30" y="350" width="210" height="85" rx="10"></rect><text class="node-label" x="48" y="398">SAP Event / Polling</text></g>
          <g id="orchestrator" data-kind="component" tabindex="0"><rect class="component-shape" x="310" y="350" width="210" height="85" rx="10"></rect><text class="node-label" x="334" y="398">Orchestrator</text></g>
          <g id="sap-rfc-bapi" data-kind="component" tabindex="0"><rect class="component-shape" x="590" y="350" width="210" height="85" rx="10"></rect><text class="node-label" x="628" y="398">SAP RFC / BAPI</text></g>
          <g id="mistral-ocr-service" data-kind="component" tabindex="0"><rect class="component-shape" x="590" y="220" width="210" height="85" rx="10"></rect><text class="node-label" x="629" y="268">Mistral OCR</text></g>
          <g id="flask-api" data-kind="component" tabindex="0"><rect class="component-shape" x="870" y="220" width="210" height="85" rx="10"></rect><text class="node-label" x="925" y="268">Flask API</text></g>
          <g id="langchain-engine" data-kind="component" tabindex="0"><rect class="component-shape" x="870" y="350" width="210" height="85" rx="10"></rect><text class="node-label" x="900" y="398">LangChain / Graph</text></g>
          <g id="rules-engine" data-kind="component" tabindex="0"><rect class="component-shape" x="1140" y="350" width="220" height="85" rx="10"></rect><text class="node-label" x="1177" y="398">Math / Rules Engine</text></g>
          <g id="react-dashboard" data-kind="component" tabindex="0"><rect class="component-shape" x="1140" y="510" width="220" height="85" rx="10"></rect><text class="node-label" x="1174" y="558">React Dashboard</text></g>
          <g id="ap-user" data-kind="component" tabindex="0"><rect class="component-shape" x="1140" y="660" width="220" height="85" rx="10"></rect><text class="node-label" x="1210" y="708">AP User</text></g>
          <g id="vector-db" data-kind="component" tabindex="0"><rect class="component-shape" x="870" y="510" width="210" height="85" rx="10"></rect><text class="node-label" x="929" y="558">Vector DB</text></g>
          <g id="logs" data-kind="component" tabindex="0"><rect class="component-shape" x="590" y="510" width="210" height="85" rx="10"></rect><text class="node-label" x="621" y="558">Logs & Decisions</text></g>
          <g id="sap-s4hana" data-kind="component" tabindex="0"><rect class="component-shape" x="310" y="510" width="210" height="85" rx="10"></rect><text class="node-label" x="344" y="558">SAP S/4HANA</text></g>

          <!-- Arrows (precise curved/bent paths) -->
          <path id="arrow-sap-event-to-orchestrator" class="arrow" d="M240 392 C270 392, 290 392, 310 392" data-kind="arrow" tabindex="0"/>
          <path id="arrow-orchestrator-to-sap-rfc" class="arrow" d="M520 392 C545 392, 565 392, 590 392" data-kind="arrow" tabindex="0"/>
          <path id="arrow-sap-to-orchestrator" class="arrow" d="M590 410 C555 450, 465 462, 430 435 C408 420, 390 410, 370 405" data-kind="arrow" tabindex="0"/>
          <path id="arrow-orchestrator-to-ocr" class="arrow" d="M430 350 C470 305, 520 270, 590 262" data-kind="arrow" tabindex="0"/>
          <path id="arrow-ocr-to-flask" class="arrow" d="M800 262 C825 262, 850 262, 870 262" data-kind="arrow" tabindex="0"/>
          <path id="arrow-flask-to-langchain" class="arrow" d="M975 305 C975 320, 975 337, 975 350" data-kind="arrow" tabindex="0"/>
          <path id="arrow-langchain-to-rules" class="arrow" d="M1080 392 C1100 392, 1120 392, 1140 392" data-kind="arrow" tabindex="0"/>
          <path id="arrow-rules-to-dashboard" class="arrow" d="M1250 435 C1250 460, 1250 485, 1250 510" data-kind="arrow" tabindex="0"/>
          <path id="arrow-dashboard-to-apuser" class="arrow" d="M1250 595 C1250 618, 1250 640, 1250 660" data-kind="arrow" tabindex="0"/>
          <path id="arrow-apuser-approved-payload" class="arrow" d="M1140 700 C990 700, 780 700, 520 550" data-kind="arrow" tabindex="0"/>
          <path id="arrow-rules-confidence" class="arrow" d="M1140 370 C1070 330, 1030 310, 975 304" data-kind="arrow" tabindex="0"/>
          <path id="arrow-langchain-to-vector" class="arrow" d="M975 435 C975 460, 975 485, 975 510" data-kind="arrow" tabindex="0"/>
          <path id="arrow-vector-to-logs" class="arrow" d="M870 552 C850 552, 825 552, 800 552" data-kind="arrow" tabindex="0"/>
          <path id="arrow-orchestrator-patch-update" class="arrow" d="M520 410 C560 430, 590 430, 640 430" data-kind="arrow" tabindex="0"/>
          <path id="arrow-sap-rfc-transactional" class="arrow" d="M590 435 C550 470, 520 500, 520 552" data-kind="arrow" tabindex="0"/>
          <path id="arrow-logs-to-sap" class="arrow" d="M590 552 C560 552, 540 552, 520 552" data-kind="arrow" tabindex="0"/>
        </svg>
        <div class="diagram-tooltip" id="diagramTooltip" role="tooltip"></div>
      </div>

      <div class="diagram-panel" aria-live="polite">
        <div class="controls">
          <button id="startFlow" type="button">Start Sequence</button>
          <button id="nextFlow" type="button">Next Step</button>
          <button id="resetFlow" type="button">Reset</button>
        </div>
        <strong id="currentStep">Current Step: Not started</strong>
        <p id="stepDetail">Hover or tap on a component/arrow to inspect details. Click highlighted element to move to the next step. Use keyboard arrows (‚Üí or ‚Üì) to advance.</p>
      </div>
    </div>

    <h2>üîç Component Deep Dive</h2>
    <ul>
      <li><strong>Orchestrator:</strong> Central process manager that receives trigger events, fetches SAP context, coordinates OCR/LLM/rules decisions, and controls write-back routing.</li>
      <li><strong>Mistral OCR Service:</strong> Extracts structured text from invoice PDF/image inputs.</li>
      <li><strong>Flask API:</strong> Normalization and API gateway layer for OCR payloads and downstream AI inference requests.</li>
      <li><strong>LangChain / Graph:</strong> Multi-step reasoning and exception classification workflow.</li>
      <li><strong>Math / Rules Engine:</strong> Deterministic validations for confidence thresholding and business constraints.</li>
      <li><strong>React Dashboard + AP User:</strong> Human-in-the-loop review for low-confidence or conflicting recommendations.</li>
      <li><strong>SAP RFC / BAPI + SAP S/4HANA:</strong> Controlled read/write integration and transactional update in system of record.</li>
    </ul>

    <h2>üß≠ Step-by-Step Data Flow</h2>
    <div class="flow-step"><strong>Step 1:</strong> Trigger & Context Build Initiation (SAP Event/Polling Trigger ‚Üí Orchestrator).</div>
    <div class="flow-step"><strong>Step 2:</strong> SAP Context Fetch (Orchestrator ‚Üî SAP RFC/BAPI for PO/GRN/Vendor and invoice metadata).</div>
    <div class="flow-step"><strong>Step 3:</strong> OCR & Data Extraction (Invoice PDF/Image ‚Üí Mistral OCR ‚Üí Flask API).</div>
    <div class="flow-step"><strong>Step 4:</strong> AI Classification and Rules (Flask ‚Üí LangChain/Graph ‚Üí Math/Rules Engine).</div>
    <div class="flow-step"><strong>Step 5:</strong> Confidence Routing (high-confidence auto-path, low-confidence to dashboard/AP user).</div>
    <div class="flow-step"><strong>Step 6:</strong> Human-in-the-loop approval and corrected payload return.</div>
    <div class="flow-step"><strong>Step 7:</strong> Write-back PATCH/Update fields and transactional SAP update.</div>
    <div class="flow-step"><strong>Step 8:</strong> Logging, decisions, and embeddings persistence.</div>

    <h2>üìã In-Scope Exception Scenarios</h2>
    <table>
      <thead><tr><th>Scenario</th><th>Description</th><th>Resolution Path</th></tr></thead>
      <tbody>
        <tr><td>PO Mismatch</td><td>Invoice line values diverge from PO tolerance.</td><td>Rules validation + optional AP review.</td></tr>
        <tr><td>Missing GRN</td><td>Invoice posted but goods receipt not found.</td><td>Context enrichment + dashboard escalation.</td></tr>
        <tr><td>Vendor/Bank Ambiguity</td><td>Multiple bank details or vendor inconsistencies.</td><td>Human-in-the-loop confirmation.</td></tr>
        <tr><td>Low OCR Confidence</td><td>Unreadable scan or incomplete extraction.</td><td>Manual correction in dashboard then resubmit.</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const details = {
      "sap-trigger": { title: "SAP Event / Polling Trigger", desc: "Publishes invoice exception signal with invoice number and exception code.", step: "Step 1" },
      "orchestrator": { title: "Orchestrator", desc: "Coordinates fetching context, OCR, AI, rules, routing and SAP write-back.", step: "Step 1-7" },
      "sap-rfc-bapi": { title: "SAP RFC / BAPI", desc: "Read/write gateway for metadata fetch and controlled transactional updates.", step: "Step 2/7" },
      "mistral-ocr-service": { title: "Mistral OCR Service", desc: "Converts invoice PDFs/images into structured OCR output.", step: "Step 3" },
      "flask-api": { title: "Flask API", desc: "Normalizes OCR JSON and sends payload to LLM workflow.", step: "Step 3-4" },
      "langchain-engine": { title: "LangChain / Graph", desc: "Performs reasoning and exception categorization.", step: "Step 4" },
      "rules-engine": { title: "Math / Rules Engine", desc: "Applies thresholds and business constraints.", step: "Step 4-5" },
      "react-dashboard": { title: "React Dashboard", desc: "Queues low-confidence exceptions for AP analyst review.", step: "Step 5-6" },
      "ap-user": { title: "AP User", desc: "Approves or corrects data and returns approved payload.", step: "Step 6" },
      "vector-db": { title: "Vector DB", desc: "Stores embeddings for learning/context retrieval.", step: "Step 8" },
      "logs": { title: "Logs & Decisions", desc: "Audits decisions, confidence and human overrides.", step: "Step 8" },
      "sap-s4hana": { title: "SAP S/4HANA", desc: "System of record where final transactional updates are committed.", step: "Step 7" },

      "arrow-sap-event-to-orchestrator": { title: "Invoice No + Exception Code", desc: "Trigger payload to orchestrator.", step: "Step 1" },
      "arrow-orchestrator-to-sap-rfc": { title: "Fetch PO/GRN/Vendor", desc: "Orchestrator requests context.", step: "Step 2" },
      "arrow-sap-to-orchestrator": { title: "Return Invoice Metadata", desc: "SAP returns enriched context.", step: "Step 2" },
      "arrow-orchestrator-to-ocr": { title: "Invoice PDF/Image", desc: "Document sent for OCR extraction.", step: "Step 3" },
      "arrow-ocr-to-flask": { title: "Structured OCR JSON", desc: "OCR output forwarded to API layer.", step: "Step 3" },
      "arrow-flask-to-langchain": { title: "Normalized Payload", desc: "Flask sends normalized payload to AI graph.", step: "Step 4" },
      "arrow-langchain-to-rules": { title: "Classification + Fields", desc: "Predictions delivered to deterministic rules.", step: "Step 4" },
      "arrow-rules-confidence": { title: "Confidence Check", desc: "High confidence routes to auto update path.", step: "Step 5" },
      "arrow-rules-to-dashboard": { title: "Exception Routing", desc: "Low confidence routed to dashboard.", step: "Step 5" },
      "arrow-dashboard-to-apuser": { title: "HITL Review", desc: "Analyst reviews and corrects exceptions.", step: "Step 6" },
      "arrow-apuser-approved-payload": { title: "Approved Payload", desc: "Human-verified corrections returned for write-back.", step: "Step 6-7" },
      "arrow-orchestrator-patch-update": { title: "PATCH / Update Fields", desc: "Orchestrator sends update-ready payload to SAP RFC/BAPI.", step: "Step 7" },
      "arrow-sap-rfc-transactional": { title: "Transactional Update", desc: "SAP commit/update to S/4HANA.", step: "Step 7" },
      "arrow-langchain-to-vector": { title: "Embeddings", desc: "Model outputs persisted for retrieval.", step: "Step 8" },
      "arrow-vector-to-logs": { title: "Logging Stream", desc: "Store vector/log artifacts and decisions.", step: "Step 8" },
      "arrow-logs-to-sap": { title: "Decision Trace", desc: "Operational trace tied to SAP lifecycle.", step: "Step 8" }
    };

    const sequence = [
      "arrow-sap-event-to-orchestrator",
      "orchestrator",
      "arrow-orchestrator-to-sap-rfc",
      "sap-rfc-bapi",
      "arrow-sap-to-orchestrator",
      "arrow-orchestrator-to-ocr",
      "mistral-ocr-service",
      "arrow-ocr-to-flask",
      "flask-api",
      "arrow-flask-to-langchain",
      "langchain-engine",
      "arrow-langchain-to-rules",
      "rules-engine",
      "arrow-rules-confidence",
      "arrow-rules-to-dashboard",
      "react-dashboard",
      "arrow-dashboard-to-apuser",
      "ap-user",
      "arrow-apuser-approved-payload",
      "arrow-orchestrator-patch-update",
      "arrow-sap-rfc-transactional",
      "sap-s4hana",
      "arrow-langchain-to-vector",
      "vector-db",
      "arrow-vector-to-logs",
      "logs",
      "arrow-logs-to-sap"
    ];

    const tooltip = document.getElementById("diagramTooltip");
    const currentStep = document.getElementById("currentStep");
    const stepDetail = document.getElementById("stepDetail");
    const svg = document.getElementById("architectureSvg");
    let sequenceIndex = -1;
    let activeEl = null;

    function showTooltip(evt, id) {
      const meta = details[id];
      if (!meta) return;
      tooltip.innerHTML = `<strong>${meta.title}</strong><br>${meta.step}<br>${meta.desc}`;
      tooltip.style.display = "block";
      positionTooltip(evt);
      currentStep.textContent = `Current Step: ${meta.step} - ${meta.title}`;
      stepDetail.textContent = meta.desc;
    }

    function positionTooltip(evt) {
      const wrap = document.getElementById("interactiveDiagram").getBoundingClientRect();
      const x = Math.min(Math.max(evt.clientX - wrap.left + 12, 8), wrap.width - tooltip.offsetWidth - 8);
      const y = Math.min(Math.max(evt.clientY - wrap.top + 12, 8), wrap.height - tooltip.offsetHeight - 8);
      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    }

    function activateElement(id, evt = null) {
      if (activeEl) activeEl.classList.remove("active");
      const el = document.getElementById(id);
      if (!el) return;
      activeEl = el;
      el.classList.add("active");
      const rect = el.getBoundingClientRect();
      const fakeEvt = evt || { clientX: rect.left + rect.width / 2, clientY: rect.top + rect.height / 2 };
      showTooltip(fakeEvt, id);
    }

    function clearActive() {
      if (activeEl) activeEl.classList.remove("active");
      activeEl = null;
      tooltip.style.display = "none";
      currentStep.textContent = "Current Step: Not started";
      stepDetail.textContent = "Hover or tap on a component/arrow to inspect details. Click highlighted element to move to the next step. Use keyboard arrows (‚Üí or ‚Üì) to advance.";
    }

    function advanceSequence() {
      sequenceIndex = (sequenceIndex + 1) % sequence.length;
      activateElement(sequence[sequenceIndex]);
    }

    Object.keys(details).forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      ["mouseover", "focus", "touchstart"].forEach((eventName) => {
        el.addEventListener(eventName, (evt) => {
          if (eventName === "touchstart") evt.preventDefault();
          activateElement(id, evt);
        }, { passive: false });
      });
      el.addEventListener("mousemove", (evt) => positionTooltip(evt));
      el.addEventListener("mouseout", () => { if (activeEl !== el) tooltip.style.display = "none"; });
      el.addEventListener("click", () => advanceSequence());
      el.addEventListener("keydown", (evt) => {
        if (evt.key === "Enter" || evt.key === " ") { evt.preventDefault(); advanceSequence(); }
      });
    });

    document.getElementById("startFlow").addEventListener("click", () => { sequenceIndex = -1; advanceSequence(); });
    document.getElementById("nextFlow").addEventListener("click", advanceSequence);
    document.getElementById("resetFlow").addEventListener("click", () => { sequenceIndex = -1; clearActive(); });

    document.addEventListener("keydown", (evt) => {
      if (evt.key === "ArrowRight" || evt.key === "ArrowDown") advanceSequence();
      if (evt.key === "Escape") { sequenceIndex = -1; clearActive(); }
    });

    svg.addEventListener("click", (evt) => {
      if (evt.target === svg) {
        sequenceIndex = -1;
        clearActive();
      }
    });
  </script>
</body>
</html>
