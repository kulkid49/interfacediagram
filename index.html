<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI‚ÄëSAP Invoice Exception ¬∑ interactive flow + step card</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #f5f7fb;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .document {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            padding: 2rem 2.5rem;
        }
        h1 {
            font-size: 2.3rem;
            font-weight: 600;
            background: linear-gradient(145deg, #1e2b4f, #2c3e6e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }
        .subhead {
            font-size: 1.1rem;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1.2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .interactive-diagram-wrap {
            margin: 20px 0;
        }
        .interactive-diagram {
            position: relative;
            width: 100%;
            border: 2px solid #1e3a5f;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            background: #fff;
        }
        .interactive-diagram img {
            width: 100%;
            height: auto;
            display: block;
        }
        .hotspot-layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .hotspot {
            cursor: pointer;
            pointer-events: auto;
            fill: rgba(30, 58, 95, 0);
            stroke: rgba(30, 58, 95, 0);
            stroke-width: 4;
            vector-effect: non-scaling-stroke;
            transition: fill 0.15s ease, stroke 0.15s ease;
            touch-action: manipulation;
        }
        .hotspot:hover,
        .hotspot:focus-visible,
        .hotspot.active {
            fill: rgba(30, 58, 95, 0.14);
            stroke: rgba(30, 58, 95, 0.75);
            outline: none;
        }
        .hotspot.selected {
            fill: rgba(30, 58, 95, 0.14);
            stroke: rgba(30, 58, 95, 0.75);
        }
        .diagram-tooltip {
            position: absolute;
            pointer-events: none;
            display: none;
            width: min(320px, 90vw);
            background: #fff;
            border: 1px solid #111;
            border-radius: 10px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.15);
            padding: 10px;
            z-index: 20;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .diagram-panel {
            margin-top: 0.9rem;
            background: #f8fbff;
            border: 1px solid #cfddee;
            border-radius: 14px;
            padding: 0.8rem 0.9rem;
            color: #1f2a44;
        }
        .diagram-panel h4 {
            margin-bottom: 0.35rem;
            color: #153157;
        }
        .panel-toolbar {
            display: none;
            justify-content: flex-end;
            margin-bottom: 0.5rem;
        }
        .panel-close {
            border: 1px solid #1e3a5f;
            background: white;
            color: #1e3a5f;
            border-radius: 999px;
            padding: 0.2rem 0.7rem;
            font-size: 0.82rem;
            cursor: pointer;
        }
        .diagram-instruction {
            font-size: 0.9rem;
            color: #4b587c;
            margin-top: 0.45rem;
        }

        /* ---------- floating step card (top‚Äëleft) ---------- */
        .side-panel {
            position: fixed;
            top: 20px;
            left: -420px;          /* hidden by default */
            width: 400px;
            max-height: 80vh;
            background: white;
            box-shadow: 4px 8px 24px rgba(0,0,0,0.25);
            border-radius: 24px;
            transition: left 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
            overflow-y: auto;
            padding: 1.5rem 1.2rem;
            z-index: 40;
            border: 1px solid #ccd9ed;
        }
        .side-panel.active {
            left: 20px;              /* slide in */
        }
        .side-panel.dragging {
            transition: none;
            user-select: none;
        }
        .side-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.7rem;
            cursor: grab;
            touch-action: none;
            margin-bottom: 1.2rem;
            padding-right: 40px;
        }
        .side-panel-header:active {
            cursor: grabbing;
        }
        .side-panel-header h2 {
            margin-bottom: 0;
        }
        .drag-hint {
            font-size: 0.78rem;
            color: #4b587c;
            background: #edf2f9;
            border: 1px solid #d5deed;
            border-radius: 999px;
            padding: 0.2rem 0.5rem;
            white-space: nowrap;
        }
        .side-panel h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e2f50;
            margin-right: 30px;
            border-bottom: 2px solid #e0e7f0;
            padding-bottom: 0.6rem;
            margin-bottom: 0;
        }
        .side-panel .close-btn {
            position: absolute;
            top: 12px;
            right: 16px;
            background: #f0f4fc;
            border: none;
            font-size: 1.8rem;
            line-height: 1;
            cursor: pointer;
            color: #1e3a5f;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }
        .side-panel .close-btn:hover {
            background: #dae3f5;
        }
        #dynamicStepList {
            list-style: decimal;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        #dynamicStepList li {
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #1f2a44;
            border-left: 3px solid #98b5db;
            padding-left: 1rem;
        }
        #dynamicStepList li strong {
            color: #0b2b55;
        }
        .no-steps-message {
            color: #5e6f8d;
            font-style: italic;
            padding: 1rem;
        }

        @media (max-width: 768px) {
            .document {
                padding: 1.4rem 1rem;
                border-radius: 20px;
            }
            h1 {
                font-size: 1.7rem;
            }
            .diagram-tooltip {
                display: none !important;
            }
            .panel-toolbar {
                display: flex;
            }
            .side-panel {
                width: 90vw;
                left: -95vw;
                top: 10px;
            }
            .side-panel.active {
                left: 5vw;
            }
            .drag-hint {
                display: none;
            }
        }

        /* original component cards (unchanged, kept compact for fidelity) */
        .arch-card {
            border-radius: 20px;
            padding: 1.2rem 1.2rem 1.5rem 1.2rem;
            border: 2px solid;
            box-shadow: 0 6px 12px rgba(0,0,0,0.04);
            background: white;
            transition: all 0.1s ease;
            margin-bottom: 1rem;
        }
        .card-header {
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px dashed rgba(0,0,0,0.1);
        }
        .badge {
            background: currentColor;
            width: 16px;
            height: 16px;
            border-radius: 6px;
            display: inline-block;
        }
        .comp-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 16px;
            margin-top: 8px;
        }
        .comp-item {
            background: #f2f5f9;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2a44;
            border: 1px solid #dde3ed;
            box-shadow: 0 1px 2px #00000008;
        }
        .comp-item strong {
            font-weight: 700;
            color: #0b1d3a;
        }
        .arrow-hint {
            font-size: 0.8rem;
            color: #4b587c;
            margin: 10px 0 0 0;
            background: #edf2f9;
            padding: 8px 12px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .two-col {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }
        .col {
            flex: 1 1 300px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #f2f6fc;
            border-radius: 20px;
            overflow: hidden;
            margin: 1.5rem 0;
        }
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #d0ddee;
        }
        th {
            background: #1e2f50;
            color: white;
            font-weight: 500;
        }
        .footnote {
            font-size: 0.9rem;
            color: #2d3c5e;
            background: #e9eefa;
            padding: 1rem 1.5rem;
            border-radius: 18px;
            margin-top: 2rem;
        }
        hr {
            border: 1px solid #e0e7f0;
            margin: 2rem 0;
        }
    </style>
</head>
<body>
<div class="document">
    <h1>Interface Design V1.0 (Flat Europe-Germany PoC)</h1>
    <div class="subhead"></div>

    <h2 style="font-size: 2rem; font-weight: 600; margin: 0 0 1rem 0;">üèûÔ∏è SYSTEM LANDSCAPE</h2>

    <!-- interactive diagram (same hotspots) -->
    <div class="interactive-diagram-wrap">
        <div class="interactive-diagram" id="interactiveDiagram" aria-label="Interactive architecture diagram">
            <img src="Data Flow Agentic BCOE 2.png" alt="AI-SAP Invoice Exception handling integration architecture diagram">
            <svg class="hotspot-layer" id="hotspotLayer" viewBox="0 0 2088 1755" preserveAspectRatio="none" aria-hidden="true"></svg>
            <div class="diagram-tooltip" id="diagramTooltip"></div>
        </div>
        <div class="diagram-panel" id="diagramPanel" aria-live="polite">
            <div class="panel-toolbar"><button id="clearSelection" class="panel-close" type="button">Clear selection</button></div>
            <h4>Interactive diagram details</h4>
            <p>Hover a component or arrow to view context. On mobile, tap a highlighted region.</p>
        </div>
        <p class="diagram-instruction">Tip: highlighted hotspots map to components and arrows from the architecture.</p>
    </div>

    <!-- ========== COMPONENT EXPLANATION (cards) ========== (original, kept fully) -->


<!-- ========== FLOATING STEP CARD (top‚Äëleft) ========== -->
<div id="sidePanel" class="side-panel">
    <button class="close-btn" id="closeSidePanel">&times;</button>
    <div class="side-panel-header" id="sidePanelHeader">
        <h2>üìã <span id="stepContextLabel">step</span></h2>
        <span class="drag-hint">Drag me</span>
    </div>
    <ol id="dynamicStepList"></ol>
</div>

<script>
    (function() {
        // ---------- step contents (exact 19 steps) ----------
        const stepLis = [
            `<li><strong>Step 1: Invoice Exception Trigger</strong><br><strong>Source</strong>: Process Director Cockpit<br><strong>Destination</strong>: SAP Event / Polling Trigger<br><strong>Description</strong>: When an invoice enters exception, the cockpit emits (or exposes for polling) the event that starts AI processing. Data: Exception event metadata.</li>`,
            `<li><strong>Step 2: Send Invoice Details</strong><br><strong>Source</strong>: SAP Event / Polling Trigger<br><strong>Destination</strong>: Orchestrator (via webhook)<br><strong>Description</strong>: SAP sends invoice-identifying event data to the orchestrator, which creates an initiated job record. Data: {event, documentNumber, exceptionCode, companyCode}.</li>`,
            `<li><strong>Step 3: Fetch Invoice Metadata</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: SAP RFC / BAPI<br><strong>Description</strong>: Orchestrator invokes read-only RFC/OData calls to gather invoice metadata and related context. Data: Invoice metadata JSON, status, simulation hints.</li>`,
            `<li><strong>Step 4: Fetch Additional SAP Data (Parallel/Related to Step 3)</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: SAP RFC / BAPI<br><strong>Description</strong>: Orchestrator requests purchase, receipt, and vendor data via the integration layer to build resolution context. Data: PO lines, GRN docs, vendor & bank records.</li>`,
            `<li><strong>Step 5: Pass Invoice Image for OCR</strong><br><strong>Source</strong>: SAP RFC / BAPI<br><strong>Destination</strong>: Mistral OCR Service<br><strong>Description</strong>: If OCR output is missing, invoice images are passed to the OCR service for document extraction. Data: Binary PDF/image.</li>`,
            `<li><strong>Step 6: Return OCR Results</strong><br><strong>Source</strong>: Mistral OCR Service<br><strong>Destination</strong>: Flask API<br><strong>Description</strong>: OCR output is normalized and merged with SAP context into a single transactional JSON snapshot. Data: Structured header + line-item JSON.</li>`,
            `<li><strong>Step 7: Process with LangGraph (Internal Routing)</strong><br><strong>Source</strong>: Flask API<br><strong>Destination</strong>: LangChain / LangGraph<br><strong>Description</strong>: Context is passed for exception classification, agentic reasoning, and confidence scoring. (This is an internal transition within the AI platform.)</li>`,
            `<li><strong>Step 8: Apply Rules Engine (Internal Processing)</strong><br><strong>Source</strong>: LangChain / LangGraph<br><strong>Destination</strong>: Math / Rules Engine<br><strong>Description</strong>: Deterministic checks (e.g., tolerance, UoM normalization) are applied alongside LLM decisions. (Internal to AI processing.)</li>`,
            `<li><strong>Step 9: Store Embeddings</strong><br><strong>Source</strong>: LangChain / LangGraph<br><strong>Destination</strong>: Vector DB / Pinecone<br><strong>Description</strong>: Semantic vectors of each context snapshot are upserted for similarity retrieval and retraining support. Data: Vector embeddings.</li>`,
            `<li><strong>Step 10: Route Based on Confidence (Conditional Branch)</strong><br><strong>Source</strong>: LangChain / LangGraph<br><strong>Destination</strong>: React Dashboard<br><strong>Description</strong>: Confidence scoring determines whether a case routes to automatic update logic or human review. Data: Confidence gate and routing metadata.</li>`,
            `<li><strong>Step 11: Human Review (HITL Interaction)</strong><br><strong>Source</strong>: React Dashboard<br><strong>Destination</strong>: AP User<br><strong>Description</strong>: Low-confidence cases are presented for review; user approves or edits. (This is a user-facing interaction.)</li>`,
            `<li><strong>Step 12: Return Approved Data (HITL Feedback Loop)</strong><br><strong>Source</strong>: React Dashboard<br><strong>Destination</strong>: Orchestrator<br><strong>Description</strong>: Low-confidence or conflicting cases are reviewed by AP users, and approved edits are returned for SAP write-back. Data: Human-reviewed correction payload.</li>`,
            `<li><strong>Step 13: Log Decisions and Outcomes</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: PostgreSQL<br><strong>Description</strong>: All decisions, API calls, and outcomes are persisted for traceability, KPI views, and compliance. Data: Audit logs, confidence scores, before/after snapshots.</li>`,
            `<li><strong>Step 14: Apply Field-Level Updates</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: SAP RFC / BAPI<br><strong>Description</strong>: For eligible cases, orchestrator sends field updates through RFCs. Data: Field-level update payloads. like - Updated material price in invoice Proposal, Assignment of Correct Bank Account</li>`,
            `<li><strong>Step 15: Commit Transactional Updates</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: SAP RFC / BAPI<br><strong>Description</strong>: Validated update requests are sent to SAP RFC for commitment in S/4HANA, preserving SAP as system of record. Data: Insert the missing PO lines into SAP invoice proposal, Remove unrelated GRN Line Items, Trigger Web Cycle / Workflow (MM_PD_B ‚Äì Price Difference Approval Before Posting)</li>`,
            `<li><strong>Step 16a: Access Invoice Management (SAP Endpoint)</strong><br><strong>Source</strong>: SAP RFC / BAPI<br><strong>Destination</strong>: Invoice Management<br><strong>Description</strong>: Updates or reads are applied to invoice metadata and status for exception resolution.</li>`,
            `<li><strong>Step 16b: Access Purchase Orders (SAP Endpoint)</strong><br><strong>Source</strong>: SAP RFC / BAPI<br><strong>Destination</strong>: Purchase Orders<br><strong>Description</strong>: Corrections are applied to PO line details, quantities, and matching attributes.</li>`,
            `<li><strong>Step 16c: Access Goods Receipt (SAP Endpoint)</strong><br><strong>Source</strong>: SAP RFC / BAPI<br><strong>Destination</strong>: Goods Receipt<br><strong>Description</strong>: Adjustments are made to GRN receipts and quantity movements for mismatch resolution.</li>`,
            `<li><strong>Step 16d: Access Vendor Master (SAP Endpoint)</strong><br><strong>Source</strong>: SAP RFC / BAPI<br><strong>Destination</strong>: Vendor Master Data<br><strong>Description</strong>: Bank account and currency selections are updated for disambiguation.</li>`
        ];

        // step associations (source/dest) ‚Äì same as original
        const stepAssociations = [
            { sources: ['pd-cockpit'], destinations: ['sap-trigger'], flows: ['flow-invoice-enters'] }, // step 0
            { sources: ['sap-trigger'], destinations: ['orchestrator'], flows: ['flow-invoice-no'] }, // step 1
            { sources: ['orchestrator'], destinations: ['sap-rfc'], flows: ['flow-fetch-meta'] }, // step 2
            { sources: ['orchestrator'], destinations: ['sap-rfc'], flows: ['flow-fetch-po-grn-vendor'] }, // step 3
            { sources: ['sap-rfc'], destinations: ['mistral-ocr'], flows: ['flow-invoice-image'] }, // step 4
            { sources: ['mistral-ocr'], destinations: ['flask-api'], flows: ['flow-ocr-json'] }, // step 5
            { sources: ['flask-api'], destinations: ['langgraph'], flows: [] }, // step 6
            { sources: ['langgraph'], destinations: ['rules-engine'], flows: [] }, // step 7
            { sources: ['langgraph'], destinations: ['pinecone'], flows: ['flow-embeddings'] }, // step 8
            { sources: ['langgraph'], destinations: ['react-dashboard'], flows: ['flow-confidence-route'] }, // step 9
            { sources: ['react-dashboard'], destinations: ['ap-user'], flows: [] }, // step 10
            { sources: ['react-dashboard'], destinations: ['orchestrator'], flows: ['flow-approved-payload'] }, // step 11
            { sources: ['orchestrator'], destinations: ['postgresql'], flows: ['flow-logs-decisions'] }, // step 12
            { sources: ['orchestrator'], destinations: ['sap-rfc'], flows: ['flow-patch-update'] }, // step 13
            { sources: ['orchestrator'], destinations: ['sap-rfc'], flows: ['flow-transactional-update'] }, // step 14
            { sources: ['sap-rfc'], destinations: ['invoice-management'], flows: [] }, // step 15
            { sources: ['sap-rfc'], destinations: ['purchase-orders'], flows: [] }, // step 16
            { sources: ['sap-rfc'], destinations: ['goods-receipt'], flows: [] }, // step 17
            { sources: ['sap-rfc'], destinations: ['vendor-master'], flows: [] } // step 18
        ];

        // build maps: for each component, which steps is it involved in (source or destination)
        const involvedStepsMap = {};
        const flowToStep = {};  // flow id -> step index
        stepAssociations.forEach((assoc, idx) => {
            [...assoc.sources, ...assoc.destinations].forEach(compId => {
                if (!involvedStepsMap[compId]) involvedStepsMap[compId] = [];
                if (!involvedStepsMap[compId].includes(idx)) involvedStepsMap[compId].push(idx);
            });
            assoc.flows.forEach(flowId => { flowToStep[flowId] = idx; });
        });

        // ---------- hotspot definitions (exactly as original) ----------
        const hotspotItems = [
            { id: 'react-dashboard', kind: 'component', x: 1595, y: 45, w: 215, h: 62, name: 'React Dashboard', description: 'Visualises HITL queue, KPIs, and audit logs; AP users can review and edit AI decisions before submission.' },
            { id: 'ap-user', kind: 'component', x: 1920, y: 45, w: 145, h: 62, name: 'AP User', description: 'Approves or corrects low-confidence cases, then sends approved payload back for SAP write-back.' },
            { id: 'postgresql', kind: 'component', x: 1298, y: 155, w: 130, h: 90, name: 'PostgreSQL', description: 'Stores job snapshots, audit logs, HITL queue, system metrics, and before/after decision traces.' },
            { id: 'pinecone', kind: 'component', x: 1278, y: 290, w: 180, h: 78, name: 'Vector DB / Pinecone', description: 'Holds semantic embeddings of context snapshots for similarity search and retraining support.' },
            { id: 'orchestrator', kind: 'component', x: 22, y: 792, w: 188, h: 64, name: 'Orchestrator', description: 'Manages agentic workflows; initiates context building, invokes SAP reads, routes exceptions, retries, and coordinates write-back.' },
            { id: 'mistral-ocr', kind: 'component', x: 705, y: 496, w: 210, h: 63, name: 'Mistral OCR Service', description: 'Extracts structured OCR JSON (headers, lines, PO references) from invoice PDF/image files.' },
            { id: 'flask-api', kind: 'component', x: 1275, y: 514, w: 125, h: 64, name: 'Flask API', description: 'Northbound API surface that receives SAP triggers, serves dashboard data, and coordinates internal services.' },
            { id: 'langgraph', kind: 'component', x: 1448, y: 665, w: 238, h: 70, name: 'LangChain / LangGraph', description: 'Performs exception classification and agentic reasoning with maintained workflow state and confidence scoring.' },
            { id: 'rules-engine', kind: 'component', x: 1820, y: 660, w: 245, h: 66, name: 'Math / Rules Engine', description: 'Runs deterministic tolerance checks, UoM normalization, and bank prioritisation logic for compliant outcomes.' },
            { id: 'sap-trigger', kind: 'component', x: 510, y: 1142, w: 250, h: 72, name: 'SAP Event / Polling Trigger', description: 'Detects exceptions in Process Director Cockpit and pushes invoice number + exception code into the integration flow.' },
            { id: 'sap-rfc', kind: 'component', x: 1455, y: 1205, w: 173, h: 66, name: 'SAP RFC / BAPI', description: 'Executes RFC/OData read and restricted write operations for metadata retrieval and transactional updates.' },
            { id: 'pd-cockpit', kind: 'component', x: 24, y: 1500, w: 240, h: 68, name: 'Process Director Cockpit', description: 'Primary invoice exception cockpit where parked invoices and workflow statuses are managed.' },
            { id: 'invoice-management', kind: 'component', x: 1858, y: 1350, w: 210, h: 68, name: 'Invoice Management', description: 'Provides invoice metadata, status, and linked document context used for exception resolution.' },
            { id: 'purchase-orders', kind: 'component', x: 1865, y: 1450, w: 185, h: 66, name: 'Purchase Orders', description: 'Source of PO line details, quantities, prices, and matching attributes for 2-way/3-way comparisons.' },
            { id: 'goods-receipt', kind: 'component', x: 1870, y: 1555, w: 175, h: 66, name: 'Goods Receipt', description: 'Supplies GRN receipts and quantity movement details for partial GRN and mismatch checks.' },
            { id: 'vendor-master', kind: 'component', x: 1850, y: 1663, w: 218, h: 66, name: 'Vendor Master Data', description: 'Provides bank account and currency records used for multiple-bank disambiguation logic.' },
            // flows
            { id: 'flow-logs-decisions', kind: 'flow', x: 400, y: 464, w: 220, h: 34, label: 'Logs & Decisions', from: 'Orchestrator', to: 'PostgreSQL', step: 'Step 7: Audit logging', data: 'Audit logs, confidence scores, before/after snapshots', description: 'All decisions, API calls, and outcomes are persisted for traceability, KPI views, and compliance.' },
            { id: 'flow-ocr-json', kind: 'flow', x: 970, y: 522, w: 250, h: 30, label: 'Structured OCR JSON', from: 'Mistral OCR Service', to: 'Flask API', step: 'Step 3: Context assembly', data: 'Structured header + line-item JSON', description: 'OCR output is normalized and merged with SAP context into a single transactional JSON snapshot.' },
            { id: 'flow-embeddings', kind: 'flow', x: 1558, y: 477, w: 130, h: 28, label: 'Embeddings', from: 'LangChain / LangGraph', to: 'Vector DB / Pinecone', step: 'Step 3', data: 'Vector embeddings', description: 'Semantic vectors of each context snapshot are upserted for similarity retrieval and retraining support.' },
            { id: 'flow-confidence-route', kind: 'flow', x: 1660, y: 333, w: 260, h: 32, label: 'Confidence & Threshold', from: 'LangChain / LangGraph', to: 'React Dashboard', step: 'Steps 4-6', data: 'Confidence gate and routing metadata', description: 'Confidence scoring determines whether a case routes to automatic update logic or human review.' },
            { id: 'flow-approved-payload', kind: 'flow', x: 1228, y: 800, w: 200, h: 28, label: 'Approved Payload', from: 'React Dashboard', to: 'Orchestrator', step: 'Step 6b: HITL', data: 'Human-reviewed correction payload', description: 'Low-confidence or conflicting cases are reviewed by AP users, and approved edits are returned for SAP write-back.' },
            { id: 'flow-fetch-meta', kind: 'flow', x: 935, y: 814, w: 250, h: 28, label: 'Fetch Invoice Metadata', from: 'Orchestrator', to: 'SAP RFC / BAPI', step: 'Step 2: Data fetch', data: 'Invoice metadata JSON, status, simulation hints', description: 'Orchestrator invokes read-only RFC/OData calls to gather invoice metadata and related context.' },
            { id: 'flow-invoice-image', kind: 'flow', x: 905, y: 866, w: 190, h: 30, label: 'Invoice PDF/Image', from: 'SAP RFC / BAPI', to: 'Mistral OCR Service', step: 'Step 2', data: 'Binary PDF/image', description: 'If OCR output is missing, invoice images are passed to the OCR service for document extraction.' },
            { id: 'flow-invoice-no', kind: 'flow', x: 432, y: 910, w: 350, h: 30, label: 'Invoice No + Exception Code', from: 'SAP Event / Polling Trigger', to: 'Orchestrator webhook', step: 'Step 1', data: '{event, documentNumber, exceptionCode, companyCode}', description: 'SAP sends invoice-identifying event data to the orchestrator, which creates an initiated job record.' },
            { id: 'flow-transactional-update', kind: 'flow', x: 560, y: 935, w: 270, h: 30, label: 'Transactional Update', from: 'Orchestrator', to: 'SAP RFC / BAPI', step: 'Step 6', data: 'Insert the missing PO lines into SAP invoice proposal, Remove unrelated GRN Line Items, Trigger Web Cycle / Workflow (MM_PD_B ‚Äì Price Difference Approval Before Posting)', description: 'Validated update requests are sent to SAP RFC for commitment in S/4HANA, preserving SAP as system of record.' },
            { id: 'flow-patch-update', kind: 'flow', x: 902, y: 965, w: 280, h: 30, label: 'PATCH / Update Fields', from: 'Orchestrator', to: 'SAP RFC / BAPI', step: 'Step 6', data: 'Field-level update payloads. like - Updated material price in invoice Proposal, Assignment of Correct Bank Account', description: 'For eligible cases, orchestrator sends field updates through RFCs.' },
            { id: 'flow-fetch-po-grn-vendor', kind: 'flow', x: 538, y: 1009, w: 250, h: 34, label: 'Fetch PO / GRN / Vendor', from: 'Orchestrator', to: 'SAP RFC / BAPI', step: 'Step 2', data: 'PO lines, GRN docs, vendor & bank records', description: 'Orchestrator requests purchase, receipt, and vendor data via the integration layer to build resolution context.' },
            { id: 'flow-invoice-enters', kind: 'flow', x: 470, y: 1520, w: 290, h: 30, label: 'Invoice Enters Exception', from: 'Process Director Cockpit', to: 'SAP Event / Polling Trigger', step: 'Step 1: Trigger & Context Build Initiation', data: 'Exception event metadata', description: 'When an invoice enters exception, the cockpit emits (or exposes for polling) the event that starts AI processing.' }
        ];

        // ----- sequence (same guided order) -----
        const sequence = [ 'pd-cockpit', 'flow-invoice-enters', 'sap-trigger', 'flow-invoice-no', 'orchestrator', 'flow-fetch-meta', 'flow-fetch-po-grn-vendor', 'sap-rfc', 'flow-invoice-image', 'mistral-ocr', 'flow-ocr-json', 'flask-api', 'langgraph', 'rules-engine', 'flow-embeddings', 'pinecone', 'flow-confidence-route', 'react-dashboard', 'ap-user', 'flow-approved-payload', 'orchestrator', 'flow-logs-decisions', 'postgresql', 'flow-patch-update', 'flow-transactional-update', 'sap-rfc', 'invoice-management', 'purchase-orders', 'goods-receipt', 'vendor-master' ];

        // ----- build source/dest map for flows using stepAssociations -----
        const flowSourceDest = {};
        hotspotItems.forEach(item => {
            if (item.kind === 'flow') {
                const stepIdx = flowToStep[item.id];
                if (stepIdx !== undefined) {
                    const assoc = stepAssociations[stepIdx];
                    if (assoc) {
                        flowSourceDest[item.id] = {
                            source: assoc.sources[0],
                            dest: assoc.destinations[0]
                        };
                    }
                }
            }
        });

        // ----- build edgeToStep for direct component transitions (no flow hotspot) -----
        const edgeToStep = {};
        stepAssociations.forEach((assoc, idx) => {
            if (assoc.sources.length === 1 && assoc.destinations.length === 1) {
                const key = `${assoc.sources[0]}|${assoc.destinations[0]}`;
                edgeToStep[key] = idx;
            }
        });

        // Explicit component-to-step mappings for endpoints that do not have direct flow hotspots.
        const componentToPrimaryStep = {
            'purchase-orders': 16, // Step 17
            'goods-receipt': 17,   // Step 18
            'vendor-master': 18    // Step 19
        };

        // ----- helper: get step indices for clicked element at given sequence index -----
        function getStepIndicesForItem(item, seqIndex) {
            if (item.kind === 'flow') {
                const stepIdx = flowToStep[item.id];
                return stepIdx !== undefined ? [stepIdx] : [];
            } else {
                const compId = item.id;

                if (componentToPrimaryStep.hasOwnProperty(compId)) {
                    return [componentToPrimaryStep[compId]];
                }

                const stepsSet = new Set();

                // scan backwards for consecutive flows that have this component as destination
                for (let j = seqIndex - 1; j >= 0; j--) {
                    const id = sequence[j];
                    const flowItem = hotspotItems.find(h => h.id === id);
                    if (!flowItem || flowItem.kind !== 'flow') break;
                    const sd = flowSourceDest[id];
                    if (sd && sd.dest === compId) {
                        const stepIdx = flowToStep[id];
                        if (stepIdx !== undefined) stepsSet.add(stepIdx);
                    } else {
                        break;
                    }
                }

                // scan forwards for consecutive flows that have this component as source
                for (let j = seqIndex + 1; j < sequence.length; j++) {
                    const id = sequence[j];
                    const flowItem = hotspotItems.find(h => h.id === id);
                    if (!flowItem || flowItem.kind !== 'flow') break;
                    const sd = flowSourceDest[id];
                    if (sd && sd.source === compId) {
                        const stepIdx = flowToStep[id];
                        if (stepIdx !== undefined) stepsSet.add(stepIdx);
                    } else {
                        break;
                    }
                }

                // add implicit steps for direct component-to-component transitions
                // previous element if it's a component
                if (seqIndex > 0) {
                    const prevId = sequence[seqIndex - 1];
                    const prevItem = hotspotItems.find(h => h.id === prevId);
                    if (prevItem && prevItem.kind === 'component') {
                        const key = `${prevId}|${compId}`;
                        if (edgeToStep.hasOwnProperty(key)) {
                            stepsSet.add(edgeToStep[key]);
                        }
                    }
                }
                // next element if it's a component
                if (seqIndex < sequence.length - 1) {
                    const nextId = sequence[seqIndex + 1];
                    const nextItem = hotspotItems.find(h => h.id === nextId);
                    if (nextItem && nextItem.kind === 'component') {
                        const key = `${compId}|${nextId}`;
                        if (edgeToStep.hasOwnProperty(key)) {
                            stepsSet.add(edgeToStep[key]);
                        }
                    }
                }

                return Array.from(stepsSet).sort((a,b) => a - b);
            }
        }

        // ----- update floating card (top‚Äëleft) -----
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelHeader = document.getElementById('sidePanelHeader');
        const dynamicList = document.getElementById('dynamicStepList');
        const stepContextLabel = document.getElementById('stepContextLabel');

        let isDraggingPanel = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        function clampPanelPosition(left, top) {
            const maxLeft = Math.max(window.innerWidth - sidePanel.offsetWidth, 0);
            const maxTop = Math.max(window.innerHeight - sidePanel.offsetHeight, 0);
            return {
                left: Math.min(Math.max(left, 0), maxLeft),
                top: Math.min(Math.max(top, 0), maxTop)
            };
        }

        function applyPanelPosition(left, top) {
            const clamped = clampPanelPosition(left, top);
            sidePanel.style.left = `${clamped.left}px`;
            sidePanel.style.top = `${clamped.top}px`;
        }

        function beginPanelDrag(event) {
            if (!sidePanel.classList.contains('active')) return;
            const rect = sidePanel.getBoundingClientRect();
            isDraggingPanel = true;
            dragOffsetX = event.clientX - rect.left;
            dragOffsetY = event.clientY - rect.top;
            sidePanel.classList.add('dragging');
            sidePanelHeader.setPointerCapture(event.pointerId);
        }

        function onPanelDrag(event) {
            if (!isDraggingPanel) return;
            event.preventDefault();
            applyPanelPosition(event.clientX - dragOffsetX, event.clientY - dragOffsetY);
        }

        function endPanelDrag(event) {
            if (!isDraggingPanel) return;
            isDraggingPanel = false;
            sidePanel.classList.remove('dragging');
            if (sidePanelHeader.hasPointerCapture(event.pointerId)) {
                sidePanelHeader.releasePointerCapture(event.pointerId);
            }
        }

        sidePanelHeader.addEventListener('pointerdown', beginPanelDrag);
        sidePanelHeader.addEventListener('pointermove', onPanelDrag);
        sidePanelHeader.addEventListener('pointerup', endPanelDrag);
        sidePanelHeader.addEventListener('pointercancel', endPanelDrag);

        window.addEventListener('resize', () => {
            if (!sidePanel.classList.contains('active')) return;
            const rect = sidePanel.getBoundingClientRect();
            applyPanelPosition(rect.left, rect.top);
        });

        function updateSidePanel(item, seqIndex) {
            const indices = getStepIndicesForItem(item, seqIndex);
            if (indices.length === 0) {
                dynamicList.innerHTML = '<div class="no-steps-message">No specific flow step for this element</div>';
                stepContextLabel.textContent = item.name || item.label || 'details';
            } else {
                const stepsHtml = indices.map(idx => stepLis[idx]).join('');
                dynamicList.innerHTML = stepsHtml;
                stepContextLabel.textContent = item.name || item.label || 'step';
            }
            sidePanel.classList.add('active');
        }

        // ----- original hotspot creation with click override -----
        const layer = document.getElementById('hotspotLayer');
        const tooltip = document.getElementById('diagramTooltip');
        const panel = document.getElementById('diagramPanel');
        const hotspots = new Map();
        let currentIndex = 0;  // position in sequence

        function panelHtml(item) {
            if (item.kind === 'component') return `<h4>${item.name}</h4><p>${item.description}</p>`;
            return `<h4>${item.label}</h4><p><strong>From:</strong> ${item.from} <strong>‚Üí To:</strong> ${item.to}</p><p><strong>${item.step}</strong> ¬∑ <strong>Data:</strong> ${item.data}</p><p>${item.description}</p>`;
        }
        function tooltipHtml(item) {
            if (item.kind === 'component') return `<strong>${item.name}</strong><br>${item.description}`;
            return `<strong>${item.label}</strong><br>${item.from} ‚Üí ${item.to}<br>${item.step}<br>${item.data}`;
        }
        function placeTooltip(event) {
            const bounds = layer.getBoundingClientRect();
            const maxX = bounds.width - tooltip.offsetWidth - 8;
            const maxY = bounds.height - tooltip.offsetHeight - 8;
            const x = Math.min(Math.max(event.clientX - bounds.left + 14, 8), Math.max(maxX, 8));
            const y = Math.min(Math.max(event.clientY - bounds.top + 14, 8), Math.max(maxY, 8));
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
        }
        function resetPanel() {
            panel.innerHTML = '<div class="panel-toolbar"><button id="clearSelection" class="panel-close" type="button">Clear selection</button></div><h4>Interactive diagram details</h4><p>Hover a component or arrow to view context. On mobile, tap a highlighted region.</p>';
            document.getElementById('clearSelection').onclick = () => {
                tooltip.style.display = 'none';
                document.querySelectorAll('.hotspot.active, .hotspot.selected').forEach(el => el.classList.remove('active', 'selected'));
                currentIndex = 0;
                sidePanel.classList.remove('active');
                resetPanel();
                // re-highlight first
                const first = hotspots.get(sequence[0]);
                if (first) {
                    first.classList.add('selected');
                    const firstItem = hotspotItems.find(i => i.id === sequence[0]);
                    if (firstItem) updateSidePanel(firstItem, 0);
                }
            };
        }

        hotspotItems.forEach(item => {
            const shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            shape.classList.add('hotspot');
            shape.dataset.kind = item.kind;
            shape.setAttribute('x', item.x);
            shape.setAttribute('y', item.y);
            shape.setAttribute('width', item.w);
            shape.setAttribute('height', item.h);
            shape.setAttribute('rx', item.kind === 'flow' ? 16 : 8);
            shape.setAttribute('ry', item.kind === 'flow' ? 16 : 8);
            shape.setAttribute('tabindex', '0');
            shape.setAttribute('role', 'button');
            shape.setAttribute('aria-label', item.kind === 'component' ? item.name : item.label);

            shape.addEventListener('mouseenter', (event) => {
                tooltip.innerHTML = tooltipHtml(item);
                tooltip.style.display = 'block';
                placeTooltip(event);
                shape.classList.add('active');
            });
            shape.addEventListener('mousemove', placeTooltip);
            shape.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
                shape.classList.remove('active');
            });
            shape.addEventListener('focus', () => {
                panel.innerHTML = panelHtml(item);
                shape.classList.add('active');
            });
            shape.addEventListener('blur', () => shape.classList.remove('active'));

            shape.addEventListener('click', (event) => {
                const itemId = item.id;
                const expectedId = sequence[currentIndex];

                // guided sequence logic (same as original)
                if (currentIndex < sequence.length - 1 && itemId === expectedId) {
                    currentIndex++;
                    document.querySelectorAll('.hotspot.selected').forEach(el => el.classList.remove('selected'));
                    const nextId = sequence[currentIndex];
                    const nextShape = hotspots.get(nextId);
                    if (nextShape) nextShape.classList.add('selected');
                    const nextItem = hotspotItems.find(i => i.id === nextId);
                    if (nextItem) updateSidePanel(nextItem, currentIndex);
                } else {
                    // manual click: set index to this item's position in sequence
                    const pos = sequence.indexOf(itemId);
                    if (pos !== -1) {
                        currentIndex = pos;
                        document.querySelectorAll('.hotspot.selected').forEach(el => el.classList.remove('selected'));
                        shape.classList.add('selected');
                        updateSidePanel(item, currentIndex);
                    } else {
                        // fallback (should not happen)
                        updateSidePanel(item, currentIndex);
                    }
                }
                document.querySelectorAll('.hotspot.active:not(.selected)').forEach(el => el.classList.remove('active'));
                sidePanel.classList.add('active');
            });

            layer.appendChild(shape);
            hotspots.set(item.id, shape);
        });

        // initial highlight
        const initialShape = hotspots.get(sequence[0]);
        if (initialShape) {
            initialShape.classList.add('selected');
            const initialItem = hotspotItems.find(i => i.id === sequence[0]);
            if (initialItem) updateSidePanel(initialItem, 0);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                tooltip.style.display = 'none';
                document.querySelectorAll('.hotspot.active, .hotspot.selected').forEach(el => el.classList.remove('active', 'selected'));
                sidePanel.classList.remove('active');
                resetPanel();
            }
        });

        document.getElementById('closeSidePanel').addEventListener('click', () => {
            sidePanel.classList.remove('active');
        });

        resetPanel();
        // ensure sidepanel starts hidden
        sidePanel.classList.remove('active');
    })();
</script>
<!-- The rest of the original content (cards, tables) would be here, unchanged -->
</body>
</html>
