<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI‚ÄëSAP Invoice Exception Handling ¬∑ Integration Architecture</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #f5f7fb;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .document {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            padding: 2rem 2.5rem;
        }
        h1 {
            font-size: 2.3rem;
            font-weight: 600;
            background: linear-gradient(145deg, #1e2b4f, #2c3e6e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }
        .subhead {
            font-size: 1.1rem;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1.2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        /* ----- image (text) display ----- */
        .ascii-diagram {
            background: #0d1b2a;        /* dark background like a terminal */
            color: #b7e4fa;
            border-radius: 24px;
            padding: 2rem 1.8rem;
            margin: 1.8rem 0 2.5rem 0;
            border: 2px solid #2d4b6e;
            box-shadow: 0 12px 24px rgba(0,20,40,0.5);
            font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-x: auto;
        }
        .ascii-diagram pre {
            margin: 0;
            font-family: inherit;
            color: #d4e6f5;
            text-shadow: 0 0 4px #3d7bb3;
        }
        /* ----- old diagram container (if needed) */
        .diagram-container {
            background: #f8fafd;
            border-radius: 28px;
            padding: 2rem 1.5rem;
            margin-bottom: 2.5rem;
            border: 1px solid #cfddee;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .diagram-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1e3a5f;
        }
        .diagram-title span {
            background: #1e3a5f;
            color: white;
            font-size: 0.9rem;
            padding: 4px 12px;
            border-radius: 40px;
            margin-left: 12px;
        }
        /* ----- explanation cards (reused from previous) ----- */
        .arch-card {
            border-radius: 20px;
            padding: 1.2rem 1.2rem 1.5rem 1.2rem;
            border: 2px solid;
            box-shadow: 0 6px 12px rgba(0,0,0,0.04);
            background: white;
            transition: all 0.1s ease;
            margin-bottom: 1rem;
        }
        .card-header {
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px dashed rgba(0,0,0,0.1);
        }
        .badge {
            background: currentColor;
            width: 16px;
            height: 16px;
            border-radius: 6px;
            display: inline-block;
        }
        .comp-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 16px;
            margin-top: 8px;
        }
        .comp-item {
            background: #f2f5f9;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2a44;
            border: 1px solid #dde3ed;
            box-shadow: 0 1px 2px #00000008;
        }
        .comp-item strong {
            font-weight: 700;
            color: #0b1d3a;
        }
        .arrow-hint {
            font-size: 0.8rem;
            color: #4b587c;
            margin: 10px 0 0 0;
            background: #edf2f9;
            padding: 8px 12px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .card-ai { border-color: #d6b656; background: #fffcf0; }
        .card-ai .card-header { color: #8b6f2c; }
        .card-integration { border-color: #6c8ebf; background: #f0f5ff; }
        .card-integration .card-header { color: #2a4b7a; }
        .card-sap { border-color: #9673a6; background: #f6f0fa; }
        .card-sap .card-header { color: #5e3c72; }
        .card-hitl { border-color: #d6b656; background: #fff7e0; }
        .card-hitl .card-header { color: #8b6f2c; }
        .card-datastore { border-color: #d6b656; background: #fff7e0; }
        .card-datastore .card-header { color: #8b6f2c; }

        .flow-step {
            background: white;
            border-left: 5px solid #2b4f8e;
            padding: 1rem 1.5rem;
            margin: 1.2rem 0;
            border-radius: 0 24px 24px 0;
            box-shadow: 0 4px 10px #eef2f6;
        }
        .flow-step h4 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #153157;
        }
        .step-number {
            background: #153157;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .two-col {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }
        .col {
            flex: 1 1 300px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #f2f6fc;
            border-radius: 20px;
            overflow: hidden;
            margin: 1.5rem 0;
        }
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #d0ddee;
        }
        th {
            background: #1e2f50;
            color: white;
            font-weight: 500;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .footnote {
            font-size: 0.9rem;
            color: #2d3c5e;
            background: #e9eefa;
            padding: 1rem 1.5rem;
            border-radius: 18px;
            margin-top: 2rem;
        }
        hr {
            border: 1px solid #e0e7f0;
            margin: 2rem 0;
        }
        .interactive-diagram-wrap {
            margin: 20px 0;
        }
        .interactive-diagram {
            position: relative;
            width: 100%;
            border: 2px solid #1e3a5f;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            background: #fff;
        }
        .interactive-diagram img {
            width: 100%;
            height: auto;
            display: block;
        }
        .hotspot-layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .hotspot {
            cursor: pointer;
            pointer-events: auto;
            fill: rgba(30, 58, 95, 0);
            stroke: rgba(30, 58, 95, 0);
            stroke-width: 4;
            vector-effect: non-scaling-stroke;
            transition: fill 0.15s ease, stroke 0.15s ease;
            touch-action: manipulation;
        }
        .hotspot:hover,
        .hotspot:focus-visible,
        .hotspot.active {
            fill: rgba(30, 58, 95, 0.14);
            stroke: rgba(30, 58, 95, 0.75);
            outline: none;
        }
        .hotspot.selected {
            fill: rgba(30, 58, 95, 0.14);
            stroke: rgba(30, 58, 95, 0.75);
        }
        .diagram-tooltip {
            position: absolute;
            pointer-events: none;
            display: none;
            width: min(320px, 90vw);
            background: #fff;
            border: 1px solid #111;
            border-radius: 10px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.15);
            padding: 10px;
            z-index: 20;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .diagram-panel {
            margin-top: 0.9rem;
            background: #f8fbff;
            border: 1px solid #cfddee;
            border-radius: 14px;
            padding: 0.8rem 0.9rem;
            color: #1f2a44;
        }
        .diagram-panel h4 {
            margin-bottom: 0.35rem;
            color: #153157;
        }
        .panel-toolbar {
            display: none;
            justify-content: flex-end;
            margin-bottom: 0.5rem;
        }
        .panel-close {
            border: 1px solid #1e3a5f;
            background: white;
            color: #1e3a5f;
            border-radius: 999px;
            padding: 0.2rem 0.7rem;
            font-size: 0.82rem;
            cursor: pointer;
        }
        .diagram-instruction {
            font-size: 0.9rem;
            color: #4b587c;
            margin-top: 0.45rem;
        }

        @media (max-width: 768px) {
            .document {
                padding: 1.4rem 1rem;
                border-radius: 20px;
            }
            h1 {
                font-size: 1.7rem;
            }
            .diagram-tooltip {
                display: none !important;
            }
            .panel-toolbar {
                display: flex;
            }
        }

        /* New styles for top right panel */
        .top-right-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            padding: 20px;
            z-index: 30;
            display: none;
            border-radius: 10px;
        }
        .top-right-panel h2 {
            margin-bottom: 1rem;
        }
        .top-right-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="document">
    <h1>Interface Design V1.0 (Flat Europe-Germany PoC)</h1>
    <div class="subhead">

    </div>

    <!-- ========== SYSTEM LANDSCAPE HEADING ========== -->
    <h2 style="font-size: 2rem; font-weight: 600; margin: 0 0 1rem 0;">üèûÔ∏è SYSTEM LANDSCAPE</h2>

    <!-- ========== THE EXACT UPLOADED IMAGE (TEXT) ========== -->

    <div class="interactive-diagram-wrap">
        <div class="interactive-diagram" id="interactiveDiagram" aria-label="Interactive architecture diagram">
            <img src="Data Flow Agentic BCOE 2.png" alt="AI-SAP Invoice Exception Handling integration architecture diagram">
            <svg class="hotspot-layer" id="hotspotLayer" viewBox="0 0 2088 1755" preserveAspectRatio="none" aria-hidden="true"></svg>
            <div class="diagram-tooltip" id="diagramTooltip"></div>
        </div>
        <div class="diagram-panel" id="diagramPanel" aria-live="polite">
            <div class="panel-toolbar"><button id="clearSelection" class="panel-close" type="button">Clear selection</button></div>
            <h4>Interactive diagram details</h4>
            <p>Hover a component or arrow to view context. On mobile, tap a highlighted region.</p>
        </div>
        <p class="diagram-instruction">Tip: highlighted hotspots map to components and arrows from the architecture, including trigger paths, SAP reads, OCR output, confidence routing, HITL and write-back flows.</p>
    </div>

    <!-- ========== COMPONENT EXPLANATION (cards) ========== -->
    <h2 style="margin: 2rem 0 1rem 0; font-weight: 600; font-size: 1.8rem;">üîç component deep dive</h2>
    <div class="two-col">
        <div class="col">
            <h3>üì¶ AI application platform (Azure VM)</h3>
            <ul style="line-height: 1.7; padding-left: 1.2rem;">
                <li><strong>Orchestrator</strong> ‚Äì agentic workflow manager; initiates context building, invokes SAP reads, routes to exception handlers, retries, and coordinates write-back.</li>
                <li><strong>Flask API</strong> ‚Äì central northbound interface; receives triggers from SAP, serves React dashboard, and calls internal components.</li>
                <li><strong>LangChain / LangGraph</strong> ‚Äì orchestrates reasoning, classification (exception type), and agentic decisions. Maintains state.</li>
                <li><strong>Mistral OCR service</strong> ‚Äì extracts structured JSON (headers, lines, PO references) from invoice PDF/image.</li>
                <li><strong>Math / rules engine</strong> ‚Äì deterministic price/quantity tolerance checks, UoM normalisation, bank prioritisation (no LLM for calculations).</li>
            </ul>
            <h3 style="margin-top: 2rem;">üóÉÔ∏è AI data stores (audit only)</h3>
            <ul style="line-height: 1.7; padding-left: 1.2rem;">
                <li><strong>PostgreSQL</strong> ‚Äì stores job snapshots, audit logs (before/after states), HITL queue, and metrics.</li>
                <li><strong>Pinecone (vector DB)</strong> ‚Äì holds embeddings of contexts for semantic similarity & future retraining.</li>
            </ul>
        </div>
        <div class="col">
            <h3>üîå integration layer</h3>
            <ul style="line-height: 1.7; padding-left: 1.2rem;">
                <li><strong>SAP event / polling trigger</strong> ‚Äì detects invoice exception in Process Director Cockpit; pushes (or polls) invoice number + exception code.</li>
                <li><strong>SAP RFC / BAPI</strong> ‚Äì all read/write operations via RFC or OData (read‚Äëonly for fetches; update restricted to specific fields like PO assignment).</li>
            </ul>
            <h3 style="margin-top: 2rem;">üè¢ SAP S/4HANA (system of record)</h3>
            <ul style="line-height: 1.7; padding-left: 1.2rem;">
                <li><strong>Process Director Cockpit</strong> ‚Äì manages invoice parking, exceptions, and workflows.</li>
                <li><strong>Invoice management, PO, GRN, vendor master</strong> ‚Äì data sources for context (invoice metadata, PO lines, GRN quantities, bank accounts).</li>
            </ul>
            <h3 style="margin-top: 2rem;">üë• human‚Äëin‚Äëthe‚Äëloop & monitoring</h3>
            <ul style="line-height: 1.7; padding-left: 1.2rem;">
                <li><strong>React dashboard</strong> ‚Äì visualises HITL queue, KPIs, audit logs; allows AP user to review/edit AI decisions.</li>
                <li><strong>AP user</strong> ‚Äì approves or corrects low‚Äëconfidence cases; edits are written back via orchestrator.</li>
            </ul>
        </div>
    </div>

    <hr>

    <!-- ========== DETAILED DATA FLOW ========== -->
    <h2 style="font-size: 1.8rem;">üîÑ step‚Äëby‚Äëstep data flow</h2>
    <p style="margin-bottom: 1.5rem; color: #2d3748;">based on integration document v1.0 (section 5). each step is numbered and mapped to the diagram.</p>

    <div class="flow-step">
        <h4><span class="step-number">1</span> Trigger & context build initiation</h4>
        <p><strong>SAP ‚Üí Integration ‚Üí Orchestrator:</strong> an invoice in Process Director Cockpit enters exception (e.g. balance not zero). SAP event bus (or poll) sends <code>{event, documentNumber, exceptionCode, companyCode}</code> to the orchestrator webhook. Orchestrator creates a job record in PostgreSQL (status=INITIATED).</p>
    </div>

    <div class="flow-step">
        <h4><span class="step-number">2</span> Data fetch from SAP (read operations)</h4>
        <p><strong>Orchestrator ‚Üí SAP RFC/BAPI:</strong> parallel or sequential RFC reads (read‚Äëonly). fetched data includes:</p>
        <ul>
            <li>Invoice metadata & status (simulation mode, error detection, 3‚Äëway match hints).</li>
            <li>Invoice image / OCR payload (if not already stored).</li>
            <li>Purchase order details (PO items, prices, quantities).</li>
            <li>Goods receipt (GRN) documents.</li>
            <li>Vendor master & banking data (bank accounts, currencies).</li>
        </ul>
        <p>If invoice image is needed, it is forwarded to Mistral OCR (local service).</p>
    </div>

    <div class="flow-step">
        <h4><span class="step-number">3</span> Context assembly</h4>
        <p><strong>Flask API + LangGraph:</strong> all fetched data + OCR output are merged into a unified JSON context object. This snapshot is stored in PostgreSQL (transactional) and a vector embedding is upserted to Pinecone (via LangChain).</p>
    </div>

    <div class="flow-step">
        <h4><span class="step-number">4</span> Exception classification</h4>
        <p><strong>LangGraph agent:</strong> uses rule‚Äëbased logic + LLM scoring to classify the specific exception type (multi‚ÄëPO, price difference, partial GRN, multiple banks, or HITL). Output includes a confidence score (0‚Äë1) and routed path.</p>
    </div>

    <div class="flow-step">
        <h4><span class="step-number">5</span> Exception‚Äëspecific processing</h4>
        <p><strong>AI internal (rules + ML):</strong> per exception, the engine performs specialised analysis:</p>
        <ul>
            <li><strong>Multi‚ÄëPO / balance not zero:</strong> NLP on OCR to identify all POs, validate via SAP, and prepare PATCH with corrected PO list.</li>
            <li><strong>Price difference:</strong> compare invoice price vs PO price + tolerance; if exceeded, prepare to trigger MM_PD_B workflow.</li>
            <li><strong>Partial GRN:</strong> fuzzy matching on quantities / dispatch note to select correct GRN; prepare removal of excess GRNs.</li>
            <li><strong>Multiple banks:</strong> match invoice currency to vendor bank accounts, flag ambiguity.</li>
        </ul>
        <p>All resolution data is held in the context object.</p>
    </div>

    <div class="flow-step">
        <h4><span class="step-number">6a</span> Write‚Äëback to SAP & workflow initiation</h4>
        <p><strong>Orchestrator ‚Üí SAP RFC (transactional):</strong> if confidence ‚â• threshold (e.g. 0.8), AI sends corrections (e.g. PATCH to assign POs, update bank selection) or triggers a workflow (MM_PD_B). For updates, RFCs are used with job ID in headers for traceability. SAP remains system of record; AI never posts directly.</p>
        <p>If confidence is low (or conflict), step 6b is invoked: HITL.</p>
    </div>

    <div class="flow-step">
        <h4><span class="step-number">6b</span> Human‚Äëin‚Äëthe‚Äëloop</h4>
        <p><strong>AI ‚Üí React Dashboard ‚Üí AP User:</strong> low‚Äëconfidence cases are inserted into HITL queue (PostgreSQL). Dashboard displays context; user approves/edits and submits. Approved payload is sent back to orchestrator, then written to SAP. Outcome is logged for retraining.</p>
    </div>

    <div class="flow-step">
        <h4><span class="step-number">7</span> Audit, logging & monitoring</h4>
        <p><strong>Every step ‚Üí PostgreSQL + Dashboard:</strong> all API requests/responses, AI decisions, scores, and snapshots are stored in <code>audit_logs</code>. React dashboard shows real‚Äëtime KPIs (throughput, resolution time, exception rates). Logs are also pushed to Azure Monitor for alerting.</p>
    </div>

    <!-- BUSINESS EXCEPTION SCENARIOS TABLE -->
    <h2 style="margin: 2.5rem 0 1rem;">üìå in‚Äëscope exception scenarios</h2>
    <table>
        <thead><tr><th>exception</th><th>AI solution (summary)</th><th>data flow reference</th></tr></thead>
        <tbody>
            <tr><td><strong>Multiple bank accounts (VMD)</strong></td><td>extract currency/region rules; prioritise; validate against VMD; escalate if ambiguous</td><td>step 2 (vendor fetch), step 5.5.4, step 6</td></tr>
            <tr><td><strong>Multiple PO numbers on invoice</strong></td><td>NLP PO detection; validate with SAP; select open/ relevant POs; PATCH to assign</td><td>step 2 (PO fetch), step 5.5.1, step 6</td></tr>
            <tr><td><strong>Price difference beyond tolerance</strong></td><td>deterministic calculation (math engine); compare tolerance; trigger MM_PD_B workflow</td><td>step 2 (PO/GRN), step 5.5.2, step 6</td></tr>
            <tr><td><strong>GRN exists but invoice not related to all GRNs</strong></td><td>fuzzy matching (item, qty, dispatch); UoM normalisation; correct GR selection</td><td>step 2 (GRN), step 5.5.3, step 6</td></tr>
        </tbody>
    </table>

    <!-- KEY PRINCIPLES & COMPLIANCE -->
    <div style="background: #eaf0fd; border-radius: 28px; padding: 1.5rem 2rem; margin-top: 2rem;">
        <div style="display: flex; gap: 3rem; flex-wrap: wrap;">
            <div><span style="font-weight:700;">üîê security & compliance</span><br>OAuth 2.0 / client certs, TLS 1.3, SAP read‚Äëonly + field‚Äëlevel write, GDPR/SOX audit trails, Azure disk encryption.</div>
            <div><span style="font-weight:700;">‚öôÔ∏è error handling</span><br>retry (3x exp. backoff), escalation to HITL, Azure Monitor alerts, SLA &lt;5 min response.</div>
            <div><span style="font-weight:700;">üßæ auditability</span><br>every decision logged with timestamp, actor, before/after snapshots; stored 7 years.</div>
        </div>
    </div>

    <div class="footnote">
        ‚ö° <strong>design principle:</strong> SAP remains system of record ‚Äî AI acts as co‚Äëprocessor, never posts directly. All postings are either auto‚Äëposting after AI preparation or human‚Äëapproved workflows.
    </div>
</div>

<!-- New top right panel for corresponding step -->
<div id="topRightPanel" class="top-right-panel">
    <button class="close-btn" id="closeTopRight">&times;</button>
    <h2>Corresponding Flow Step</h2>
    <div id="stepContent"></div>
</div>

<script>
    const hotspotItems = [
        { id: 'react-dashboard', kind: 'component', x: 1595, y: 45, w: 215, h: 62, name: 'React Dashboard', description: 'Visualises HITL queue, KPIs, and audit logs; AP users can review and edit AI decisions before submission.' },
        { id: 'ap-user', kind: 'component', x: 1920, y: 45, w: 145, h: 62, name: 'AP User', description: 'Approves or corrects low-confidence cases, then sends approved payload back for SAP write-back.' },
        { id: 'postgresql', kind: 'component', x: 1298, y: 155, w: 130, h: 90, name: 'PostgreSQL', description: 'Stores job snapshots, audit logs, HITL queue, system metrics, and before/after decision traces.' },
        { id: 'pinecone', kind: 'component', x: 1278, y: 290, w: 180, h: 78, name: 'Vector DB / Pinecone', description: 'Holds semantic embeddings of context snapshots for similarity search and retraining support.' },

        { id: 'orchestrator', kind: 'component', x: 22, y: 792, w: 188, h: 64, name: 'Orchestrator', description: 'Manages agentic workflows; initiates context building, invokes SAP reads, routes exceptions, retries, and coordinates write-back.' },
        { id: 'mistral-ocr', kind: 'component', x: 705, y: 496, w: 210, h: 63, name: 'Mistral OCR Service', description: 'Extracts structured OCR JSON (headers, lines, PO references) from invoice PDF/image files.' },
        { id: 'flask-api', kind: 'component', x: 1275, y: 514, w: 125, h: 64, name: 'Flask API', description: 'Northbound API surface that receives SAP triggers, serves dashboard data, and coordinates internal services.' },
        { id: 'langgraph', kind: 'component', x: 1448, y: 665, w: 238, h: 70, name: 'LangChain / LangGraph', description: 'Performs exception classification and agentic reasoning with maintained workflow state and confidence scoring.' },
        { id: 'rules-engine', kind: 'component', x: 1820, y: 660, w: 245, h: 66, name: 'Math / Rules Engine', description: 'Runs deterministic tolerance checks, UoM normalization, and bank prioritisation logic for compliant outcomes.' },

        { id: 'sap-trigger', kind: 'component', x: 510, y: 1142, w: 250, h: 72, name: 'SAP Event / Polling Trigger', description: 'Detects exceptions in Process Director Cockpit and pushes invoice number + exception code into the integration flow.' },
        { id: 'sap-rfc', kind: 'component', x: 1455, y: 1205, w: 173, h: 66, name: 'SAP RFC / BAPI', description: 'Executes RFC/OData read and restricted write operations for metadata retrieval and transactional updates.' },

        { id: 'pd-cockpit', kind: 'component', x: 24, y: 1500, w: 240, h: 68, name: 'Process Director Cockpit', description: 'Primary invoice exception cockpit where parked invoices and workflow statuses are managed.' },
        { id: 'invoice-management', kind: 'component', x: 1844, y: 1360, w: 210, h: 68, name: 'Invoice Management', description: 'Provides invoice metadata, status, and linked document context used for exception resolution.' },
        { id: 'purchase-orders', kind: 'component', x: 1865, y: 1460, w: 185, h: 66, name: 'Purchase Orders', description: 'Source of PO line details, quantities, prices, and matching attributes for 2-way/3-way comparisons.' },
        { id: 'goods-receipt', kind: 'component', x: 1870, y: 1572, w: 175, h: 66, name: 'Goods Receipt', description: 'Supplies GRN receipts and quantity movement details for partial GRN and mismatch checks.' },
        { id: 'vendor-master', kind: 'component', x: 1836, y: 1690, w: 218, h: 66, name: 'Vendor Master Data', description: 'Provides bank account and currency records used for multiple-bank disambiguation logic.' },

        { id: 'flow-logs-decisions', kind: 'flow', x: 400, y: 464, w: 220, h: 34, label: 'Logs & Decisions', from: 'Orchestrator', to: 'PostgreSQL', step: 'Step 7: Audit logging', data: 'Audit logs, confidence scores, before/after snapshots', description: 'All decisions, API calls, and outcomes are persisted for traceability, KPI views, and compliance.' },
        { id: 'flow-ocr-json', kind: 'flow', x: 970, y: 522, w: 250, h: 30, label: 'Structured OCR JSON', from: 'Mistral OCR Service', to: 'Flask API', step: 'Step 3: Context assembly', data: 'Structured header + line-item JSON', description: 'OCR output is normalized and merged with SAP context into a single transactional JSON snapshot.' },
        { id: 'flow-embeddings', kind: 'flow', x: 1558, y: 477, w: 130, h: 28, label: 'Embeddings', from: 'LangChain / LangGraph', to: 'Vector DB / Pinecone', step: 'Step 3', data: 'Vector embeddings', description: 'Semantic vectors of each context snapshot are upserted for similarity retrieval and retraining support.' },
        { id: 'flow-confidence-route', kind: 'flow', x: 1660, y: 333, w: 260, h: 32, label: 'Confidence & Threshold', from: 'LangChain / LangGraph', to: 'React Dashboard', step: 'Steps 4-6', data: 'Confidence gate and routing metadata', description: 'Confidence scoring determines whether a case routes to automatic update logic or human review.' },
        { id: 'flow-confidence', kind: 'flow', x: 710, y: 749, w: 270, h: 28, label: 'Confidence >= Threshold', from: 'LangChain / LangGraph', to: 'Orchestrator', step: 'Steps 4-6', data: 'Confidence score + route', description: 'High-confidence classifications continue to deterministic checks and automated correction/write-back preparation.' },
        { id: 'flow-approved-payload', kind: 'flow', x: 1228, y: 800, w: 200, h: 28, label: 'Approved Payload', from: 'React Dashboard', to: 'Orchestrator', step: 'Step 6b: HITL', data: 'Human-reviewed correction payload', description: 'Low-confidence or conflicting cases are reviewed by AP users, and approved edits are returned for SAP write-back.' },
        { id: 'flow-fetch-meta', kind: 'flow', x: 935, y: 814, w: 250, h: 28, label: 'Fetch Invoice Metadata', from: 'Orchestrator', to: 'SAP RFC / BAPI', step: 'Step 2: Data fetch', data: 'Invoice metadata JSON, status, simulation hints', description: 'Orchestrator invokes read-only RFC/OData calls to gather invoice metadata and related context.' },
        { id: 'flow-invoice-image', kind: 'flow', x: 905, y: 866, w: 190, h: 30, label: 'Invoice PDF/Image', from: 'SAP RFC / BAPI', to: 'Mistral OCR Service', step: 'Step 2', data: 'Binary PDF/image', description: 'If OCR output is missing, invoice images are passed to the OCR service for document extraction.' },
        { id: 'flow-invoice-no', kind: 'flow', x: 432, y: 910, w: 350, h: 30, label: 'Invoice No + Exception Code', from: 'SAP Event / Polling Trigger', to: 'Orchestrator webhook', step: 'Step 1', data: '{event, documentNumber, exceptionCode, companyCode}', description: 'SAP sends invoice-identifying event data to the orchestrator, which creates an initiated job record.' },
        { id: 'flow-transactional-update', kind: 'flow', x: 560, y: 935, w: 270, h: 30, label: 'Transactional Update', from: 'Orchestrator', to: 'SAP RFC / BAPI', step: 'Step 6', data: 'Committed correction transaction', description: 'Validated update requests are sent to SAP RFC for commitment in S/4HANA, preserving SAP as system of record.' },
        { id: 'flow-patch-update', kind: 'flow', x: 902, y: 965, w: 280, h: 30, label: 'PATCH / Update Fields', from: 'Orchestrator', to: 'SAP RFC / BAPI', step: 'Step 6', data: 'Field-level update payloads', description: 'For eligible cases, orchestrator sends restricted field updates (e.g., PO assignment, bank selection) through RFCs.' },
        { id: 'flow-fetch-po-grn-vendor', kind: 'flow', x: 538, y: 1009, w: 250, h: 34, label: 'Fetch PO / GRN / Vendor', from: 'Orchestrator', to: 'SAP RFC / BAPI', step: 'Step 2', data: 'PO lines, GRN docs, vendor & bank records', description: 'Orchestrator requests purchase, receipt, and vendor data via the integration layer to build resolution context.' },
        { id: 'flow-invoice-enters', kind: 'flow', x: 470, y: 1520, w: 290, h: 30, label: 'Invoice Enters Exception', from: 'Process Director Cockpit', to: 'SAP Event / Polling Trigger', step: 'Step 1: Trigger & Context Build Initiation', data: 'Exception event metadata', description: 'When an invoice enters exception, the cockpit emits (or exposes for polling) the event that starts AI processing.' }
    ];
    const layer = document.getElementById('hotspotLayer');
    const tooltip = document.getElementById('diagramTooltip');
    const panel = document.getElementById('diagramPanel');
    const interactiveDiagram = document.getElementById('interactiveDiagram');
    const defaultPanelHtml = '<div class="panel-toolbar"><button id="clearSelection" class="panel-close" type="button">Clear selection</button></div><h4>Interactive diagram details</h4><p>Hover a component or arrow to view context. On mobile, tap a highlighted region.</p>';

    const sequence = [
        'pd-cockpit',
        'flow-invoice-enters',
        'sap-trigger',
        'flow-invoice-no',
        'orchestrator',
        'flow-fetch-meta',
        'flow-fetch-po-grn-vendor',
        'sap-rfc',
        'flow-invoice-image',
        'mistral-ocr',
        'flow-ocr-json',
        'flask-api',
        'langgraph',
        'rules-engine',
        'flow-embeddings',
        'pinecone',
        'flow-confidence-route',
        'react-dashboard',
        'ap-user',
        'flow-approved-payload',
        'orchestrator',
        'flow-logs-decisions',
        'postgresql',
        'flow-patch-update',
        'flow-transactional-update',
        'sap-rfc',
        'invoice-management',
        'purchase-orders',
        'goods-receipt',
        'vendor-master'
    ];

    let currentIndex = 0;

    function panelHtml(item) {
        if (item.kind === 'component') {
            return `<h4>\( {item.name}</h4><p> \){item.description}</p>`;
        }
        return `<h4>${item.label}</h4><p><strong>From:</strong> ${item.from} <strong>‚Üí To:</strong> \( {item.to}</p><p><strong> \){item.step}</strong> ¬∑ <strong>Data:</strong> \( {item.data}</p><p> \){item.description}</p>`;
    }

    function tooltipHtml(item) {
        if (item.kind === 'component') {
            return `<strong>\( {item.name}</strong><br> \){item.description}`;
        }
        return `<strong>\( {item.label}</strong><br> \){item.from} ‚Üí \( {item.to}<br> \){item.step}<br>${item.data}`;
    }

    function placeTooltip(event) {
        const bounds = layer.getBoundingClientRect();
        const maxX = bounds.width - tooltip.offsetWidth - 8;
        const maxY = bounds.height - tooltip.offsetHeight - 8;
        const x = Math.min(Math.max(event.clientX - bounds.left + 14, 8), Math.max(maxX, 8));
        const y = Math.min(Math.max(event.clientY - bounds.top + 14, 8), Math.max(maxY, 8));
        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;
    }

    const SVG_NS = 'http://www.w3.org/2000/svg';

    function updateDetails(item, event) {
        panel.innerHTML = panelHtml(item);
        tooltip.innerHTML = tooltipHtml(item);
        if (event) {
            tooltip.style.display = 'block';
            placeTooltip(event);
        }
    }

    function resetPanel() {
        panel.innerHTML = defaultPanelHtml;
        const renewedClearBtn = document.getElementById('clearSelection');
        if (renewedClearBtn) {
            renewedClearBtn.onclick = () => {
                tooltip.style.display = 'none';
                document.querySelectorAll('.hotspot.active').forEach((el) => el.classList.remove('active'));
                document.querySelectorAll('.hotspot.selected').forEach((el) => el.classList.remove('selected'));
                currentIndex = 0;
                resetPanel();
            };
        }
    }

    const hotspots = new Map();

    hotspotItems.forEach((item) => {
        const shape = document.createElementNS(SVG_NS, 'rect');
        shape.classList.add('hotspot');
        shape.dataset.kind = item.kind;
        shape.setAttribute('x', item.x);
        shape.setAttribute('y', item.y);
        shape.setAttribute('width', item.w);
        shape.setAttribute('height', item.h);
        shape.setAttribute('rx', item.kind === 'flow' ? 16 : 8);
        shape.setAttribute('ry', item.kind === 'flow' ? 16 : 8);
        shape.setAttribute('tabindex', '0');
        shape.setAttribute('role', 'button');
        shape.setAttribute('aria-label', item.kind === 'component' ? item.name : item.label);

        shape.addEventListener('mouseenter', (event) => {
            updateDetails(item, event);
            shape.classList.add('active');
        });

        shape.addEventListener('mousemove', placeTooltip);

        shape.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
            shape.classList.remove('active');
        });

        shape.addEventListener('focus', () => {
            panel.innerHTML = panelHtml(item);
            shape.classList.add('active');
        });

        shape.addEventListener('blur', () => {
            shape.classList.remove('active');
        });

        shape.addEventListener('click', (event) => {
            const itemId = item.id;
            const currentId = sequence[currentIndex];
            if (currentIndex < sequence.length - 1 && itemId === currentId) {
                // Advance to next
                currentIndex++;
                document.querySelectorAll('.hotspot.selected').forEach((el) => el.classList.remove('selected'));
                const nextId = sequence[currentIndex];
                const nextShape = hotspots.get(nextId);
                nextShape.classList.add('selected');
                const nextItem = hotspotItems.find(i => i.id === nextId);
                updateDetails(nextItem, event);
            } else {
                // Jump to this one
                document.querySelectorAll('.hotspot.selected').forEach((el) => el.classList.remove('selected'));
                shape.classList.add('selected');
                updateDetails(item, event);
                currentIndex = sequence.indexOf(itemId);
            }
            // Remove temporary active from others if needed
            document.querySelectorAll('.hotspot.active:not(.selected)').forEach((el) => el.classList.remove('active'));

            // Show corresponding step in top right if it's a flow with matching content
            if (item.kind === 'flow') {
                const content = stepByFlowLabel[item.label];
                if (content) {
                    document.getElementById('stepContent').innerHTML = content;
                    topRightPanel.style.display = 'block';
                }
            }
        });

        layer.appendChild(shape);
        hotspots.set(item.id, shape);
    });

    // Initial highlight
    const initialId = sequence[0];
    const initialShape = hotspots.get(initialId);
    if (initialShape) {
        initialShape.classList.add('selected');
        const initialItem = hotspotItems.find(item => item.id === initialId);
        updateDetails(initialItem);
    }

    interactiveDiagram.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            tooltip.style.display = 'none';
            document.querySelectorAll('.hotspot.active').forEach((el) => el.classList.remove('active'));
            document.querySelectorAll('.hotspot.selected').forEach((el) => el.classList.remove('selected'));
            resetPanel();
        }
    });

    resetPanel();

    // Top right panel functionality
    const topRightPanel = document.getElementById('topRightPanel');
    const closeTopRight = document.getElementById('closeTopRight');
    closeTopRight.addEventListener('click', () => {
        topRightPanel.style.display = 'none';
    });

    // Map of flow labels to their corresponding step content
    const stepByFlowLabel = {
        'Invoice Enters Exception': '<strong>Step 1: Invoice Exception Trigger</strong><br><strong>Source</strong>: Process Director Cockpit<br><strong>Destination</strong>: SAP Event / Polling Trigger<br><strong>Flow Label</strong>: Invoice Enters Exception<br><strong>Diagram Step Reference</strong>: Step 1: Trigger & Context Build Initiation<br><strong>Description</strong>: When an invoice enters exception, the cockpit emits (or exposes for polling) the event that starts AI processing. Data: Exception event metadata.',
        'Invoice No + Exception Code': '<strong>Step 2: Send Invoice Details</strong><br><strong>Source</strong>: SAP Event / Polling Trigger<br><strong>Destination</strong>: Orchestrator (via webhook)<br><strong>Flow Label</strong>: Invoice No + Exception Code<br><strong>Diagram Step Reference</strong>: Step 1<br><strong>Description</strong>: SAP sends invoice-identifying event data to the orchestrator, which creates an initiated job record. Data: {event, documentNumber, exceptionCode, companyCode}.',
        'Fetch Invoice Metadata': '<strong>Step 3: Fetch Invoice Metadata</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: SAP RFC / BAPI<br><strong>Flow Label</strong>: Fetch Invoice Metadata<br><strong>Diagram Step Reference</strong>: Step 2: Data fetch<br><strong>Description</strong>: Orchestrator invokes read-only RFC/OData calls to gather invoice metadata and related context. Data: Invoice metadata JSON, status, simulation hints.',
        'Fetch PO / GRN / Vendor': '<strong>Step 4: Fetch Additional SAP Data (Parallel/Related to Step 3)</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: SAP RFC / BAPI<br><strong>Flow Label</strong>: Fetch PO / GRN / Vendor<br><strong>Diagram Step Reference</strong>: Step 2<br><strong>Description</strong>: Orchestrator requests purchase, receipt, and vendor data via the integration layer to build resolution context. Data: PO lines, GRN docs, vendor & bank records.',
        'Invoice PDF/Image': '<strong>Step 5: Pass Invoice Image for OCR</strong><br><strong>Source</strong>: SAP RFC / BAPI<br><strong>Destination</strong>: Mistral OCR Service<br><strong>Flow Label</strong>: Invoice PDF/Image<br><strong>Diagram Step Reference</strong>: Step 2<br><strong>Description</strong>: If OCR output is missing, invoice images are passed to the OCR service for document extraction. Data: Binary PDF/image.',
        'Structured OCR JSON': '<strong>Step 6: Return OCR Results</strong><br><strong>Source</strong>: Mistral OCR Service<br><strong>Destination</strong>: Flask API<br><strong>Flow Label</strong>: Structured OCR JSON<br><strong>Diagram Step Reference</strong>: Step 3: Context assembly<br><strong>Description</strong>: OCR output is normalized and merged with SAP context into a single transactional JSON snapshot. Data: Structured header + line-item JSON.',
        'Embeddings': '<strong>Step 9: Store Embeddings</strong><br><strong>Source</strong>: LangChain / LangGraph<br><strong>Destination</strong>: Vector DB / Pinecone<br><strong>Flow Label</strong>: Embeddings<br><strong>Diagram Step Reference</strong>: Step 3<br><strong>Description</strong>: Semantic vectors of each context snapshot are upserted for similarity retrieval and retraining support. Data: Vector embeddings.',
        'Confidence & Threshold': '<strong>Step 10: Route Based on Confidence (Conditional Branch)</strong><br><strong>Source</strong>: LangChain / LangGraph<br><strong>Destination</strong>: React Dashboard<br><strong>Flow Label</strong>: Confidence & Threshold<br><strong>Diagram Step Reference</strong>: Steps 4-6<br><strong>Description</strong>: Confidence scoring determines whether a case routes to automatic update logic or human review. Data: Confidence gate and routing metadata.',
        'Approved Payload': '<strong>Step 12: Return Approved Data (HITL Feedback Loop)</strong><br><strong>Source</strong>: React Dashboard<br><strong>Destination</strong>: Orchestrator<br><strong>Flow Label</strong>: Approved Payload<br><strong>Diagram Step Reference</strong>: Step 6b: HITL<br><strong>Description</strong>: Low-confidence or conflicting cases are reviewed by AP users, and approved edits are returned for SAP write-back. Data: Human-reviewed correction payload.',
        'Logs & Decisions': '<strong>Step 13: Log Decisions and Outcomes</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: PostgreSQL<br><strong>Flow Label</strong>: Logs & Decisions<br><strong>Diagram Step Reference</strong>: Step 7: Audit logging<br><strong>Description</strong>: All decisions, API calls, and outcomes are persisted for traceability, KPI views, and compliance. Data: Audit logs, confidence scores, before/after snapshots.',
        'PATCH / Update Fields': '<strong>Step 14: Apply Field-Level Updates</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: SAP RFC / BAPI<br><strong>Flow Label</strong>: PATCH / Update Fields<br><strong>Diagram Step Reference</strong>: Step 6<br><strong>Description</strong>: For eligible cases, orchestrator sends restricted field updates (e.g., PO assignment, bank selection) through RFCs. Data: Field-level update payloads.',
        'Transactional Update': '<strong>Step 15: Commit Transactional Updates</strong><br><strong>Source</strong>: Orchestrator<br><strong>Destination</strong>: SAP RFC / BAPI<br><strong>Flow Label</strong>: Transactional Update<br><strong>Diagram Step Reference</strong>: Step 6<br><strong>Description</strong>: Validated update requests are sent to SAP RFC for commitment in S/4HANA, preserving SAP as system of record. Data: Committed correction transaction.'
    };
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cf1c00b6bb087ee',t:'MTc3MTI5NDI0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>